<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - ME-SHOPZ</title>
  <script>
    (function(){
      try{
        var t = localStorage.getItem('theme');
        if(!t){ t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'; }
        var de=document.documentElement, b=document.body;
        if(t==='dark'){ de.classList.add('dark'); de.removeAttribute('data-theme'); if(b) b.removeAttribute('data-theme'); de.style.colorScheme='dark'; }
        else { de.classList.remove('dark'); de.setAttribute('data-theme','light'); if(b) b.setAttribute('data-theme','light'); de.style.colorScheme='light'; }
      }catch(e){}
    })();
  </script>
  <link rel="stylesheet" href="css/main.css">
  <style>
    .form-container { max-width: 800px; margin: var(--spacing-2xl) auto; }
    .form-section { background: white; padding: var(--spacing-2xl); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: var(--spacing-lg); }
    .form-section h2 { margin-top: 0; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--gray-light); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); }
    .form-row.full { grid-template-columns: 1fr; }
    .image-upload { border: 2px dashed var(--gray-light); padding: var(--spacing-2xl); border-radius: var(--border-radius); text-align: center; cursor: pointer; transition: var(--transition); }
    .image-upload:hover { border-color: var(--primary); background-color: rgba(52,152,219,0.05); }
    .image-upload p { margin: 0; color: var(--gray); }
    .image-preview { margin-top: var(--spacing-lg); }
    .image-preview img { max-width: 200px; border-radius: var(--border-radius); }
    .form-actions { display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-2xl); }
    .form-actions .btn { min-width: 150px; }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div style="margin: var(--spacing-xl) 0;">
      <a href="/dashboard.html" style="color: var(--primary);">‚Üê Back to Dashboard</a>
    </div>

    <div class="form-container">
      <div class="form-section">
        <h2>Add New Product</h2>

        <form id="productForm">
          <!-- Basic Information -->
          <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
              <label for="productName">Product Name</label>
              <input type="text" id="productName" name="productName" placeholder="Enter product name" required>
            </div>

            <div class="form-group">
              <label for="productDesc">Product Description</label>
              <textarea id="productDesc" name="productDesc" placeholder="Describe your product..." required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category" required>
                  <option value="">Select Category</option>
                  <option value="electronics">Electronics</option>
                  <option value="clothing">Clothing</option>
                  <option value="books">Books</option>
                  <option value="home">Home & Garden</option>
                </select>
              </div>
              <div class="form-group">
                <label for="sku">SKU</label>
                <input type="text" id="sku" name="sku" placeholder="Product SKU" required>
              </div>
            </div>
          </div>

          <!-- Pricing -->
          <div class="form-section">
            <h3>Pricing & Inventory</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="price">Regular Price ($)</label>
                <input type="number" id="price" name="price" placeholder="99.99" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="discountPrice">Discount Price ($)</label>
                <input type="number" id="discountPrice" name="discountPrice" placeholder="79.99" step="0.01">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="stock">Stock Quantity</label>
                <input type="number" id="stock" name="stock" placeholder="100" min="0" required>
              </div>
              <div class="form-group">
                <label for="weight">Weight (kg)</label>
                <input type="number" id="weight" name="weight" placeholder="1.5" step="0.01">
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="form-section">
            <h3>Product Images</h3>
            
            <div class="form-group">
              <label>Main Image</label>
              <div class="image-upload" id="imageUpload" onclick="document.getElementById('imageInput').click()">
                <p>üì∏ Click to upload or drag & drop</p>
                <p style="font-size: var(--font-size-sm); margin-top: 8px;">PNG, JPG up to 5MB</p>
              </div>
              <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;">
              <div class="image-preview" id="imagePreview"></div>
            </div>
          </div>

          <!-- Specifications -->
          <div class="form-section">
            <h3>Specifications</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="brand">Brand</label>
                <input type="text" id="brand" name="brand" placeholder="Product brand">
              </div>
              <div class="form-group">
                <label for="color">Color</label>
                <input type="text" id="color" name="color" placeholder="Product color">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="material">Material</label>
                <input type="text" id="material" name="material" placeholder="Material composition">
              </div>
              <div class="form-group">
                <label for="warranty">Warranty Period</label>
                <input type="text" id="warranty" name="warranty" placeholder="e.g., 2 Years">
              </div>
            </div>
          </div>

          <!-- SEO -->
          <div class="form-section">
            <h3>SEO & Visibility</h3>
            
            <div class="form-group">
              <label for="metaTitle">Meta Title</label>
              <input type="text" id="metaTitle" name="metaTitle" placeholder="Page title for search engines" maxlength="60">
            </div>

            <div class="form-group">
              <label for="metaDesc">Meta Description</label>
              <textarea id="metaDesc" name="metaDesc" placeholder="Description for search engines" maxlength="160" style="min-height: 80px;"></textarea>
            </div>

            <div class="form-group">
              <label for="tags">Tags (comma separated)</label>
              <input type="text" id="tags" name="tags" placeholder="electronics, gadgets, tech">
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="reset" class="btn btn-outline">Clear Form</button>
            <button type="submit" class="btn btn-primary btn-lg">Add Product</button>
            <a href="/dashboard.html" class="btn btn-outline">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="js/utils.js"></script>
  <script src="js/validators.js"></script>
  <script src="js/navbar.js"></script>
  <script src="js/footer.js"></script>
  <script src="js/theme-toggle.js" defer></script>
  <script>
    requireRole('shopkeeper');

    const form = el('#productForm');
    const imageInput = el('#imageInput');
    const imageUpload = el('#imageUpload');
    const imagePreview = el('#imagePreview');
    const imageHandler = new ImageUploadHandler('#imageInput', '#imagePreview', 5);

    const validator = new FormValidator(form);
    validator.addRule('productName', v => Validators.required(v), 'Product name required');
    validator.addRule('productDesc', v => Validators.minLength(v, 10), 'Description must be 10+ characters');
    validator.addRule('category', v => Validators.required(v), 'Category required');
    validator.addRule('sku', v => Validators.required(v), 'SKU required');
    validator.addRule('price', v => Validators.number(v), 'Valid price required');
    validator.addRule('stock', v => v >= 0, 'Stock cannot be negative');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validator.validate()) return;

      const data = getFormData(form);
      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Adding product...';

      const productData = {
        name: data.productName,
        description: data.productDesc,
        category: data.category,
        sku: data.sku,
        price: parseFloat(data.price),
        discountPrice: data.discountPrice ? parseFloat(data.discountPrice) : null,
        stock: parseInt(data.stock),
        brand: data.brand,
        color: data.color,
        material: data.material,
        warranty: data.warranty,
        weight: data.weight ? parseFloat(data.weight) : null,
        metaTitle: data.metaTitle,
        metaDescription: data.metaDesc,
        tags: data.tags ? data.tags.split(',').map(t => t.trim()) : []
      };

      const result = await apiPost('/products', productData);

      if (result.success) {
        showAlert('Product added successfully!', 'success');
        setTimeout(() => {
          window.location.href = '/dashboard.html';
        }, 1500);
      } else {
        showAlert(result.error || 'Failed to add product', 'danger');
        btn.disabled = false;
        btn.textContent = 'Add Product';
      }
    });

    // Drag and drop for images
    imageUpload.addEventListener('dragover', (e) => {
      e.preventDefault();
      addClass(imageUpload, 'drag-over');
    });

    imageUpload.addEventListener('dragleave', () => {
      removeClass(imageUpload, 'drag-over');
    });

    imageUpload.addEventListener('drop', (e) => {
      e.preventDefault();
      removeClass(imageUpload, 'drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        imageInput.files = files;
        imageHandler.handleFileSelect({ target: { files } });
      }
    });
  </script>
</body>
</html>
