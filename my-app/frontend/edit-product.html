<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Product - ME-SHOPZ</title>
  <script>
    (function(){
      try{
        var t = localStorage.getItem('theme');
        if(!t){ t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'; }
        var de=document.documentElement, b=document.body;
        if(t==='dark'){ de.classList.add('dark'); de.removeAttribute('data-theme'); if(b) b.removeAttribute('data-theme'); de.style.colorScheme='dark'; }
        else { de.classList.remove('dark'); de.setAttribute('data-theme','light'); if(b) b.setAttribute('data-theme','light'); de.style.colorScheme='light'; }
      }catch(e){}
    })();
  </script>
  <link rel="stylesheet" href="css/main.css">
  <style>
    .form-container { max-width: 800px; margin: var(--spacing-2xl) auto; }
    .form-section { background: white; padding: var(--spacing-2xl); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: var(--spacing-lg); }
    .form-section h2 { margin-top: 0; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-lg); border-bottom: 2px solid var(--gray-light); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); }
    .form-row.full { grid-template-columns: 1fr; }
    .image-upload { border: 2px dashed var(--gray-light); padding: var(--spacing-2xl); border-radius: var(--border-radius); text-align: center; cursor: pointer; transition: var(--transition); }
    .image-upload:hover { border-color: var(--primary); background-color: rgba(52,152,219,0.05); }
    .image-preview { margin-top: var(--spacing-lg); }
    .image-preview img { max-width: 200px; border-radius: var(--border-radius); }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 999px; background: var(--success); color: white; font-size: var(--font-size-sm); }
    .form-actions { display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-2xl); }
    .form-actions .btn { min-width: 150px; }
    .danger-zone { background: #fff5f5; border: 1px solid #f8d7da; padding: var(--spacing-lg); border-radius: var(--border-radius); margin-top: var(--spacing-2xl); }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="container">
    <div style="margin: var(--spacing-xl) 0;">
      <a href="/dashboard.html" style="color: var(--primary);">‚Üê Back to Dashboard</a>
    </div>

    <div class="form-container">
      <div class="form-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
          <h2 style="margin: 0;">Edit Product</h2>
          <span class="status-badge" id="statusBadge">Active</span>
        </div>

        <form id="productForm">
          <!-- Basic Information -->
          <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
              <label for="productName">Product Name</label>
              <input type="text" id="productName" name="productName" placeholder="Enter product name" required>
            </div>

            <div class="form-group">
              <label for="productDesc">Product Description</label>
              <textarea id="productDesc" name="productDesc" placeholder="Describe your product..." required></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category" required>
                  <option value="">Select Category</option>
                  <option value="electronics">Electronics</option>
                  <option value="clothing">Clothing</option>
                  <option value="books">Books</option>
                  <option value="home">Home & Garden</option>
                </select>
              </div>
              <div class="form-group">
                <label for="sku">SKU</label>
                <input type="text" id="sku" name="sku" placeholder="Product SKU" required>
              </div>
            </div>
          </div>

          <!-- Pricing -->
          <div class="form-section">
            <h3>Pricing & Inventory</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="price">Regular Price ($)</label>
                <input type="number" id="price" name="price" placeholder="99.99" step="0.01" required>
              </div>
              <div class="form-group">
                <label for="discountPrice">Discount Price ($)</label>
                <input type="number" id="discountPrice" name="discountPrice" placeholder="79.99" step="0.01">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="stock">Stock Quantity</label>
                <input type="number" id="stock" name="stock" placeholder="100" min="0" required>
              </div>
              <div class="form-group">
                <label for="weight">Weight (kg)</label>
                <input type="number" id="weight" name="weight" placeholder="1.5" step="0.01">
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="form-section">
            <h3>Product Images</h3>
            
            <div class="form-group">
              <label>Main Image</label>
              <div class="image-upload" id="imageUpload" onclick="document.getElementById('imageInput').click()">
                <p>üì∏ Click to upload or drag & drop</p>
                <p style="font-size: var(--font-size-sm); margin-top: 8px;">PNG, JPG up to 5MB</p>
              </div>
              <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;">
              <div class="image-preview" id="imagePreview"></div>
            </div>
          </div>

          <!-- Specifications -->
          <div class="form-section">
            <h3>Specifications</h3>
            
            <div class="form-row">
              <div class="form-group">
                <label for="brand">Brand</label>
                <input type="text" id="brand" name="brand" placeholder="Product brand">
              </div>
              <div class="form-group">
                <label for="color">Color</label>
                <input type="text" id="color" name="color" placeholder="Product color">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="material">Material</label>
                <input type="text" id="material" name="material" placeholder="Material composition">
              </div>
              <div class="form-group">
                <label for="warranty">Warranty Period</label>
                <input type="text" id="warranty" name="warranty" placeholder="e.g., 2 Years">
              </div>
            </div>
          </div>

          <!-- Status -->
          <div class="form-section">
            <h3>Status</h3>
            
            <div class="form-group">
              <label for="status">Product Status</label>
              <select id="status" name="status" required>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="draft">Draft</option>
                <option value="discontinued">Discontinued</option>
              </select>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="reset" class="btn btn-outline">Reset Changes</button>
            <button type="submit" class="btn btn-primary btn-lg">Update Product</button>
            <a href="/dashboard.html" class="btn btn-outline">Cancel</a>
          </div>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h3 style="margin-top: 0; color: var(--danger);">Danger Zone</h3>
            <p style="margin: 0 0 12px 0; color: var(--danger);">Deleting this product is permanent and cannot be undone.</p>
            <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deleteProduct()">Delete Product</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="js/utils.js"></script>
  <script src="js/validators.js"></script>
  <script src="js/navbar.js"></script>
  <script src="js/footer.js"></script>
  <script src="js/theme-toggle.js" defer></script>
  <script>
    requireRole('shopkeeper');

    const params = new URLSearchParams(window.location.search);
    const productId = params.get('id');

    // Mock product data
    const mockProduct = {
      id: productId,
      name: 'Premium Wireless Headphones',
      description: 'High-quality wireless headphones with active noise cancellation',
      category: 'electronics',
      sku: 'WH-1000',
      price: 99.99,
      discountPrice: 79.99,
      stock: 25,
      brand: 'AudioPro',
      color: 'Black',
      material: 'Aluminum & Plastic',
      warranty: '2 Years',
      weight: 0.25,
      status: 'active'
    };

    const form = el('#productForm');
    const imageHandler = new ImageUploadHandler('#imageInput', '#imagePreview', 5);
    const validator = new FormValidator(form);

    validator.addRule('productName', v => Validators.required(v), 'Product name required');
    validator.addRule('productDesc', v => Validators.minLength(v, 10), 'Description must be 10+ characters');
    validator.addRule('price', v => Validators.number(v), 'Valid price required');

    async function loadProduct() {
      try {
        const result = await apiGet(`/products/${productId}`);
        if (result.success) {
          displayProduct(result.data);
        }
      } catch {
        displayProduct(mockProduct);
      }
    }

    function displayProduct(product) {
      setFormData(form, {
        productName: product.name,
        productDesc: product.description,
        category: product.category,
        sku: product.sku,
        price: product.price,
        discountPrice: product.discountPrice,
        stock: product.stock,
        brand: product.brand,
        color: product.color,
        material: product.material,
        warranty: product.warranty,
        weight: product.weight,
        status: product.status
      });

      setText('#statusBadge', product.status.toUpperCase());
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validator.validate()) return;

      const data = getFormData(form);
      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Updating...';

      const productData = {
        name: data.productName,
        description: data.productDesc,
        category: data.category,
        sku: data.sku,
        price: parseFloat(data.price),
        discountPrice: data.discountPrice ? parseFloat(data.discountPrice) : null,
        stock: parseInt(data.stock),
        brand: data.brand,
        color: data.color,
        material: data.material,
        warranty: data.warranty,
        weight: data.weight ? parseFloat(data.weight) : null,
        status: data.status
      };

      const result = await apiPut(`/products/${productId}`, productData);

      if (result.success) {
        showAlert('Product updated successfully!', 'success');
        setTimeout(() => {
          window.location.href = '/dashboard.html';
        }, 1500);
      } else {
        showAlert(result.error || 'Failed to update product', 'danger');
        btn.disabled = false;
        btn.textContent = 'Update Product';
      }
    });

    async function deleteProduct() {
      if (!confirm('Are you sure? This cannot be undone.')) return;

      const result = await apiDelete(`/products/${productId}`);

      if (result.success) {
        showAlert('Product deleted successfully', 'success');
        setTimeout(() => {
          window.location.href = '/dashboard.html';
        }, 1500);
      } else {
        showAlert(result.error || 'Failed to delete product', 'danger');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadProduct);
    } else {
      loadProduct();
    }
  </script>
</body>
</html>
